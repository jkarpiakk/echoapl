<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formularz ECHO</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.0.2/build/index.js"></script>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Formularz badania echokardiograficznego</h1>
    <form id="echoForm" class="space-y-8">
      <!-- 1. Dane pacjenta -->
      <section>
        <h2 class="text-2xl font-semibold mb-4">1. Dane pacjenta</h2>
        <div class="grid grid-cols-2 gap-6">
          <div>
            <label for="name" class="block text-gray-700 mb-1">Nazwisko i Imię</label>
            <input type="text" id="name" name="NAZWISKO IMIĘ" class="w-full border-gray-300 rounded-md" required>
          </div>
          <div>
            <label for="id" class="block text-gray-700 mb-1">Nr badania / ID pacjenta</label>
            <input type="text" id="id" name="Nr badania / ID pacjenta" class="w-full border-gray-300 rounded-md" required>
          </div>
          <div>
            <label for="examDate" class="block text-gray-700 mb-1">Data badania</label>
            <input type="date" id="examDate" name="Data badania" class="w-full border-gray-300 rounded-md" required>
          </div>
          <div>
            <label for="operator" class="block text-gray-700 mb-1">Operator / lekarz</label>
            <input type="text" id="operator" name="Operator / lekarz" class="w-full border-gray-300 rounded-md" required>
          </div>
          <div>
            <label for="age" class="block text-gray-700 mb-1">Wiek</label>
            <input type="number" id="age" name="WIEK" class="w-24 border-gray-300 rounded-md" min="0" required>
          </div>
          <div>
            <label class="block text-gray-700 mb-1">Płeć</label>
            <div class="flex items-center space-x-4">
              <label class="inline-flex items-center">
                <input type="radio" name="PŁEĆ 0- KOBIETA 1- MĘŻCZYZNA" value="0" class="form-radio" checked>
                <span class="ml-2">Kobieta</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="PŁEĆ 0- KOBIETA 1- MĘŻCZYZNA" value="1" class="form-radio">
                <span class="ml-2">Mężczyzna</span>
              </label>
            </div>
          </div>
          <div>
            <label for="height" class="block text-gray-700 mb-1">Wzrost (cm)</label>
            <input type="number" id="height" name="WZROST [cm]" class="w-full border-gray-300 rounded-md" min="0">
          </div>
          <div>
            <label for="weight" class="block text-gray-700 mb-1">Waga (kg)</label>
            <input type="number" id="weight" name="WAGA [kg]" class="w-full border-gray-300 rounded-md" step="0.1">
          </div>
          <div>
            <label for="bmi" class="block text-gray-700 mb-1">BMI (kg/m²)</label>
            <input type="number" id="bmi" name="BMI [kg/m2]" class="w-full border-gray-300 rounded-md bg-gray-100" readonly>
          </div>
        </div>
      </section>

      <!-- 2. Choroby współistniejące -->
      <section>
        <h2 class="text-2xl font-semibold mb-4">2. Choroby współistniejące / czynniki ryzyka</h2>
        <div class="grid grid-cols-3 gap-4">
          <label class="inline-flex items-center">
            <input type="checkbox" name="NT 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Nadciśnienie tętnicze (NT)</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" name="DM 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Cukrzyca (DM)</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" name="PCHN 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Przewlekła choroba nerek (PChN)</span>
          </label>
          <div>
            <label for="egfr" class="block text-gray-700 mb-1">eGFR [ml/min/1.73m²]</label>
            <input type="number" id="egfr" name="eGFR [ml/min/1.73m2]" class="w-32 border-gray-300 rounded-md">
          </div>
          <label class="inline-flex items-center">
            <input type="checkbox" name="POChP 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">POChP / Astma</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" name="CAD 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Choroba wieńcowa (CAD)</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" name="PCI 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Przebyty PCI</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" name="CABG 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Przebyty CABG</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" name="HF 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Niewydolność serca (HF)</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" name="AF 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Migotanie przedsionków (AF)</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" name="Smoking 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Palenie tytoniu</span>
          </label>
          <label class="inline-flex items-center">
            <input type="checkbox" name="Stroke/TIA 0- NIE 1- TAK" class="form-checkbox">
            <span class="ml-2">Udar/TIA</span>
          </label>
        </div>
      </section>

      <!-- Further sections (Laboratory, Medications, Echo measurements, Valves, EKG, Follow-up) go here similarly -->

      <!-- Export buttons -->
      <section class="mt-6">
        <button type="button" onclick="exportCSV()" class="px-4 py-2 bg-blue-600 text-white rounded-md mr-4">Eksportuj CSV</button>
        <button type="button" onclick="exportDocx()" class="px-4 py-2 bg-green-600 text-white rounded-md">Eksportuj DOCX</button>
      </section>
    </form>
  </div>

  <script>
    // Dynamic BMI calculation
    const heightInput = document.getElementById('height');
    const weightInput = document.getElementById('weight');
    const bmiInput = document.getElementById('bmi');
    function calcBMI() {
      const h = parseFloat(heightInput.value) || 0;
      const w = parseFloat(weightInput.value) || 0;
      bmiInput.value = (h > 0 && w > 0) ? (w/Math.pow(h/100,2)).toFixed(1) : '';
    }
    heightInput.addEventListener('input', calcBMI);
    weightInput.addEventListener('input', calcBMI);

    // CSV export
    function exportCSV() {
      const data = new FormData(document.getElementById('echoForm'));
      const headers = Array.from(data.keys());
      let csv = headers.join(';') + '\n' + headers.map(h => {
        let v = data.get(h);
        if(v === null) v = h.includes('0- NIE 1- TAK') ? '0' : '';
        return `"${v}"`;
      }).join(';');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'echo_data.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // DOCX export
    async function exportDocx() {
      const f = new FormData(document.getElementById('echoForm'));
      const doc = new docx.Document();
      doc.addSection({ children: [
        new docx.Paragraph({ text: 'Raport ECHO', heading: docx.HeadingLevel.HEADING_1 }),
        new docx.Paragraph(`Pacjent: ${f.get('NAZWISKO IMIĘ') || ''}`),
        new docx.Paragraph(`Data badania: ${f.get('Data badania') || ''}`),
        new docx.Paragraph(`Operator: ${f.get('Operator / lekarz') || ''}`),
      ]});
      const blob = await docx.Packer.toBlob(doc);
      const docBlob = blob.slice(0, blob.size, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
      saveAs(docBlob, 'echo_report.docx');
    }
  </script>
</body>
</html>
